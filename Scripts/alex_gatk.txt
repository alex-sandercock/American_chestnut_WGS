## I put GATK software in /groups/jah1_lab/alex just in case
## New versions on the web may work differently
## This code will give a .g.vcf file for each sample in the outdir
## It may take a couple days to run this
##First part takes over 1 hour per sample to run.
module load jdk/1.8.0

#-Xmx200g is stating that 200G of memory will be allocated for the process
#need to have either output file extension.g.vcf, or include --variant_index_type LINEAR --variant_index_parameter 128000
for sample in $(ls *.bam)
do
java -Xmx200g -jar path_to_GATK/GenomeAnalysisTK.jar \
	-R path_to_reference_genome/Castanea_dentata.mainGenome.fasta \
	-T HaplotypeCaller \
	-I $sample \
	--emitRefConfidence GVCF \
	-o output_directory/output_file.g.vcf

##May need to delete .idx files before running next step to speed up process and allow code to make new .idx files on the fly	
## Then you run this to merge them all together and get a SNP set across all samples
# ls *.g.vcf > gatl.list  <-- this makes a list of .vcf files to be read
java -Xmx200g -jar path_to_GATK/GenomeAnalysisTK.jar \
   -T GenotypeGVCFs \
	-R path_to_reference_genome/Castanea_dentata.mainGenome.fasta \
   --variant list_of_samples.list \
   -o snps.vcf
   
## Filter this set for quality
## this code may throw a bunch of warnings; ignore them
java -Xmx200g -jar path_to_GATK/GenomeAnalysisTK.jar \
   -T VariantFiltration \
   -R path_to_reference_genome/Castanea_dentata.mainGenome.fasta \
   -o snps_filtered.vcf \
   --variant snps.vcf \
   --filterExpression "QD < 2.0" \
   --filterName "MQ" \
   --filterExpression "MQ < 40.00" \
   --filterName "MQ" \
   --filterExpression "FS > 40.000" \
   --filterName "FS" \
   --filterExpression "MQRankSum < -12.500" \
   --filterName "MQRankSum" \
   --filterExpression "ReadPosRankSum < -8.000" \
   --filterName "ReadPosRankSum" \
   --filterExpression "SOR > 3.0" \
   --filterName "SOR" 	
   
## This will delete SNPs that didn't pass the quality check above
java -Xmx200g -jar path_to_GATK/GenomeAnalysisTK.jar \
   -R path_to_reference_genome/Castanea_dentata.mainGenome.fasta \
   -T SelectVariants \
   -V snps_filtered.vcf \
   -o snps_filtered_remove_fail.vcf \
   -ef

## Finally I use vcftools to filter on missing data (<10%) 
## I also put a working copy of vcftools in your folder
path_to_vcftools --vcf snps_filtered_remove_fail.vcf --max-alleles 2 --max-missing 0.9 \
	--out snps_filtered_remove_fail_maf_0.01_miss_0.9 --recode

done